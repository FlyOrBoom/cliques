<!DOCTYPE html>
<html lang=en-US dir=ltr>
  	<head>
		<meta charset=utf-8>

		<title>Cliques!</title>
		<meta name=description content=''>
		<meta name=author content='Xing Liu'>
		<meta name=viewport content='width=device-width, initial-scale=1.0'>

		<link rel=icon type=image/png href=/icon.png>
    <style>
html, body {
  background: white;
  margin: 0;
  width: 100%;
  height: 100%;
}
body {
  display: flex;
  font-size: 12pt;
}
body > * {
  height: 100%;
  overflow: scroll;
  box-sizing: border-box;
  padding: 1rem;
}
aside {
  max-width: 20rem;
}
main {
  display: grid;
  flex-grow: 1;
	grid-template-columns: repeat(auto-fit, minmax(10rem, 1fr));
	grid-auto-rows: auto;
  grid-gap: 1rem;
}
aside label {
  display: flex;
  flex-direction: column;
}

.card {
  border-radius: 1rem;
  padding: 1rem;
}
    
/* colors */
.f0_0 { background: red }
.f0_1 { background: green }
.f0_2 { background: blue }

/* shades */
.f1_0 { opacity: 0.5 }
.f1_1 { opacity: 0.75 }
.f1_2 { opacity: 1 }

/* counts */
.f2_0 {  }
.f2_1 {  }
.f2_2 {  }

/* shapes */
.f3_0 {  }
.f3_1 {  }
.f3_2 {  }

/* rotations */
.f4_0 { transform: rotate(0deg) }
.f4_1 { transform: rotate(45deg) }
.f4_2 { transform: rotate(-45deg) }

/* something */
.f5_0 {  }
.f5_1 {  }
.f5_2 {  }

    </style>
	</head>
	<body>
		<aside>
			<h1>Cliques!</h1>
			<section>
				<h2>Players</h2>
				<ol id=players>
					<li>You</li>
				</ol>
        <label>
          <span>Invite others online:</span>
         <input type=text readonly value=https://x-ing.space/cliques#pqrstuvwxyz disabled>
        </label>
			</section>
			<form id=settings>
				<h2>Settings</h2>
				<label id=time>
					<span>Time limit (seconds) (0 is infinite)</span>
					<input type=number min=0 max=300 value=10 disabled>
					<input type=range min=0 max=300 value=10 disabled>
				</label>
				<label id=features>
					<span>Difficulty (number of features per card)</span>
					<input type=number min=3 max=6 value=4>
					<input type=range min=3 max=6 value=4>
				</label>
				<label id=features>
					<span>Threshold for extra cards (% voted in favor)</span>
					<input type=number min=0 max=100 value=100 disabled>
					<input type=range min=0 max=100 value=100 disabled>
				</label>
				<input type=submit value='New game'>
			</form>
			<form id=preferences>
				<h2>Preferences</h2>
				<label id=palette>
					<span>Color palette</span>
					<input type=number min=0 max=3 value=0 disabled>
					<input type=range min=0 max=3 value=0 disabled>
				</label>
				<label id=look>
					<span>Look</span>
					<input type=number min=0 max=3 value=0 disabled>
					<input type=range min=0 max=3 value=0 disabled>
				</label>
			</form>
			<section>
				<h2>How to play</h2>
				<p>Cliques is Xingâ€™s open-source adaptation of the mathematical card game Set by Marsha Falco.</p>
				<p>In this game, each card has four features: number, shading, color, and shape. Each characteristic has 3 possible variations.</p>
				<p>To play, select a trio of cards. You score a point if that trio of cards is a <em>clique</em>, and lose a point otherwise.</p>
				<p>A trio is considered a <em>clique</em> if for every feature, either all three cards have the same variation, or all three cards have different variations.</p>
			</section>
      <section>
        <h2>History</h2>
        <label>
          <span>Log</span>
          <textarea id=log readonly></textarea>
        </label>
      </section>
		</aside>
		<main id=game>
		</main>
    <template id=template-card>
      <label class=card>
        <input class=checkbox type=checkbox>
        <input class=value type=text readonly value=0_0_0_0>
      </label>
    </template>
    <template id=template-player>
      <li class=player></li>
    </template>
		<script>
    
// shortcuts for selecting elements
const $ = (query = '*', target = document) => target.querySelector(query)
const $$ = (query = '*', target = document) => Array.from(target.querySelectorAll(query))

// create array of 0's
const A = (size) => Array(size).fill(0)

// count frequency of values in array
const N = (array, value) => array.filter(v => v===value).length

// get template
const T = (id) => document.getElementById('template-' + id)
.content.cloneNode(true)
.firstElementChild

// state
const s = {
  constants: {
	  clique: 3, // # of cards per clique, and # of variations per feature
  },
  elements: {
    game: $('#game'),
    players: $('#players'),
    settings: $('#settings'),
    log: $('#log'),
  },
  settings: {
    features: 4, // # of features per card
  },
  preferences: {
    palette: 0,
    look: 0,
  },
  players: {
    [Math.random()]: {
      score: 0,
      name: 'You',
      local: true,
    }
  },
  game: {
    selected: [], // selected cards
    sums: [], // sum of card feature & variations
    turn: 0, // id of current turn player
    deck: [], // all unused cards
    visible: [], // all visible cards
    history: [], // history of cliques & miscliques
  }
}

$$('aside label').forEach(label=>{
	label.addEventListener('input',event=>{
		s.settings[event.target.parentElement.id] = parseInt(event.target.value)
		$$('input', label).forEach(input=>{
			input.value = event.target.value
		})
	})
})

s.elements.game.addEventListener('change',event => {
  
  const card = event.target.parentElement.id
  
  // adding or removing a card?
  const addition = event.target.checked
  addition ? s.game.selected.push(card) : s.game.selected.splice(s.game.selected.indexOf(card))
  
  // update sum
  event.target.parentElement.id
  .split('_')
  .forEach((feature,index)=>s.game.sums[index][feature] += addition ? 1 : -1)
  
  // if clique reached
  if(s.game.selected.length === s.constants.clique) {
    const valid = (
      s.game.sums.every(
      feature =>
      N(feature,1).length === s.constants.clique ||
      N(feature,s.constants.clique).length === 1
    ))
    
    // take turns changing scores
    s.players[s.game.turn].score += valid ? 1 : -1
    
    if(valid){
      s.game.selected
      .map( card => s.game.visible.indexOf(card) )
      .forEach( index => s.game.visible[index] = s.game.deck.pop() )
    }
    
    s.game.history.push(
      new Date().toLocaleTimeString() + ': '
      + s.players[s.game.turn].name
      + (valid ? ' cliqued ' : ' miscliqued ')
      + s.game.selected.join(', ')
    )
    s.game.selected = []
    renderGame()
  }
	//console.log(s.game)
  
})

function newGame(){

	// generate cards
	s.game.deck = (
    
    // allocate space for all cards in deck
    A(s.constants.clique ** s.settings.features)
    
    // add in cards
    .map( (_,i) =>
      
      // allocate space for each feature
      A(s.settings.features)
      
      // unwrap index into features
      // similar to breaking down a number into component digits 
      .map( (_,k) => Math.floor( i / s.constants.clique**k ) % s.constants.clique )
      
      // strings are easier to handle with HTML
      .join('_')
    )
    
    // shuffle
    .map((value) => ({ value, sort: Math.random() }))
    .sort((a, b) => a.sort - b.sort)
    .map(({ value }) => value)
  )

	// put some on the table
	s.game.visible = (
    
    // allocate space for all visible cards
    A(s.constants.clique * s.settings.features)
    
    // remove from deck
    .map( _ => s.game.deck.pop() )
  )
  
  // keep track of selected features & variations
  s.game.sums = (
    
    // allocate space for each feature
    A(s.settings.features)
    
    // allocate space for each variation
    .map( _ => A(s.constants.clique) )
    
  )
  
  s.game.history = []
  s.game.selected = []
  
  s.game.scores = A(s.players.length)
  s.game.turn = Object.keys(s.players)[0]
  
	//console.log(s.settings)
  renderGame()
}

function renderGame(){
  s.elements.game.replaceChildren(...
    s.game.visible
    .map(card => {
      const element = T('card')
      
      // create classes for CSS, f{feature id}_{variation id}
      element.classList = (
        card.split('_')
        .map( (feature,index) => 'f'+index+'_'+feature )
        .join(' ')
      )
     
      $('.checkbox',element).checked = s.game.selected.includes(card)
      
      element.id = $('.value',element).value = card
      
      return element
    })
  )
  s.elements.players.replaceChildren(...
    Object.values(s.players)
    .map((player, index) => {
      const element = T('player')
      element.textContent = `${player.name} (${player.score})`
      return element
    })
  )
  console.log(s.game.history)
  s.elements.log.value = s.game.history.join('\n')
}

// new game
s.elements.settings.addEventListener('submit',event=>{
  event.preventDefault()
  newGame()
})

newGame()
		</script>
	</body>
</html>
