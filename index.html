<!DOCTYPE html>
<html lang=en-US dir=ltr>
  	<head>
		<meta charset=utf-8>

		<title>Cliques!</title>
		<meta name=description content=''>
		<meta name=author content='Xing Liu'>
		<meta name=viewport content='width=device-width, initial-scale=1.0'>

		<link rel=icon type=image/png href=/icon.png>
	</head>
	<body>
		<aside>
			<h1>Cliques!</h1>
			<section>
				<h2>Players</h2>
				<ol id=players>
					<li>You</li>
				</ol>
				Invite others: <input type=text readonly value=https://x-ing.space/cliques#pqrstuvwxyz>
			</section>
			<form id=settings>
				<h2>Settings</h2>
				<label id=features>
					<span>Features</span>
					<input type=number min=3 max=5 value=4>
					<input type=range min=3 max=5 value=4>
				</label>
				<input type=submit value='New game'>
			</form>
			<form id=preferences>
				<h2>Preferences</h2>
				<label id=palette>
					<span>Palette</span>
					<input type=number min=0 max=3 value=0>
					<input type=range min=0 max=3 value=0>
				</label>
				<label id=look>
					<span>Look</span>
					<input type=number min=0 max=3 value=0>
					<input type=range min=0 max=3 value=0>
				</label>
			</form>
			<section>
				<h2>How to play</h2>
				<p>Cliques is an open-source variant of Set.</p>
				<p>In this game, each card has four features - number, shading, color, and shape - and each characteristic has 3 variations.</p>
				<p>To play, select a trio of cards. You score a point if that trio of cards is a <em>clique</em>, and lose a point otherwise.</p>
				<p>A trio is considered a <em>clique</em> if, for each characteristic, all three cards have the same variation, or all three cards have different variations.</p>
			</section>
		</aside>
		<main id=game>
		</main>
    <template id=template>
      <label class=card>
        <input class=checkbox type=checkbox>
        <input class=value type=text readonly value=0_0_0_0>
      </label>
    </template>
		<script>
    
// shortcuts for selecting elements
const $ = (query = '*', target = document) => target.querySelector(query)
const $$ = (query = '*', target = document) => Array.from(target.querySelectorAll(query))

// create array of 0's
const A = (size) => Array(size).fill(0)

// count frequency of values in array
const N = (array, value) => array.filter(v => v===value).length

// state
const s = {
  constants: {
	  clique: 3, // # of cards per clique, and # of variations per feature
  },
  elements: {
    game: $('#game'),
    settings: $('#settings'),
  },
  settings: {
    features: 4, // # of features per card
  },
  preferences: {
    palette: 0,
    look: 0,
  },
  players: [ 'You', 'Me' ],
  game: {
    selected: [],
    sums: [],
    scores: [],
    turn: 0,
    deck: [],
    visible: [],
    history: [],
  }
}

$$('label').forEach(label=>{
	label.addEventListener('input',event=>{
		s.settings[event.target.id] = parseInt(event.target.value)
		$$('input', label).forEach(input=>{
			input.value = event.target.value
		})
	})
})

s.elements.settings.addEventListener('submit',newGame)

s.elements.game.addEventListener('change',event => {
  
  const card = event.target.parentElement.id
  
  // adding or removing a card?
  const addition = event.target.checked
  addition ? s.game.selected.push(card) : s.game.selected.splice(s.game.selected.indexOf(card))
  
  // update sum
  event.target.parentElement.id
  .split('_')
  .forEach((feature,index)=>s.game.sums[index][feature] += addition ? 1 : -1)
  
  // if clique reached
  if(s.game.selected.length === s.constants.clique) {
    const valid = (
      s.game.sums.every(
      feature =>
      N(feature,1).length === s.constants.clique ||
      N(feature,s.constants.clique).length === 1
    ))
    
    // take turns changing scores
    s.game.scores[s.game.turn] += valid ? 1 : -1
    s.game.turn ++
    s.game.turn %= s.players.length
    
    if(valid){
      s.game.selected
      .map( card => s.game.visible.indexOf(card) )
      .forEach( index => s.game.visible[index] = s.game.deck.pop() )
    }
    
    s.game.history.push(s.game.selected.join(', '))
    s.game.selected = []
    renderGame()
  }
	console.log(s.game)
  
})

function newGame(){

	// generate cards
	s.game.deck = (
    
    // allocate space for all cards in deck
    A(s.constants.clique ** s.settings.features)
    
    // add in cards
    .map( (_,i) =>
      
      // allocate space for each feature
      A(s.settings.features)
      
      // unwrap index into features
      // similar to breaking down a number into component digits 
      .map( (_,k) => Math.floor( i / s.constants.clique**k ) % s.constants.clique )
      
      // strings are easier to handle with HTML
      .join('_')
    )
    
    // shuffle
    .map((value) => ({ value, sort: Math.random() }))
    .sort((a, b) => a.sort - b.sort)
    .map(({ value }) => value)
  )

	// put some on the table
	s.game.visible = (
    
    // allocate space for all visible cards
    A(s.constants.clique * s.settings.features)
    
    // remove from deck
    .map( _ => s.game.deck.pop() )
  )
  
  // keep track of selected features & variations
  s.game.sums = (
    
    // allocate space for each feature
    A(s.settings.features)
    
    // allocate space for each variation
    .map( _ => A(s.constants.clique) )
    
  )
  
  s.game.history = s.game.selected = []
  
  s.game.scores = A(s.players.length)
  s.game.turn = 0
  
	console.log(s.game)
}

function renderGame(){
  $('#game').replaceChildren(...
    s.game.visible
    .map(card => {
      const element = document.getElementById('template')
      .content.cloneNode(true)
      .firstElementChild
      $('.checkbox',element).checked = s.game.selected.includes(card)
      element.id = $('.value',element).value = card
      return element
    })
  )
  $('#players').replaceChildren(...
    s.players
    .map((name, index) => {
      const element = document.createElement('li')
      element.textContent = `${name} (${s.game.scores[index]})`
      return element
    })
  )
}


newGame()
renderGame()
		</script>
	</body>
</html>
