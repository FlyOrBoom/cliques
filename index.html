
<!DOCTYPE html>
<html lang=en-US dir=ltr>
  	<head>
		<meta charset=utf-8>

		<title>Cliques!</title>
		<meta name=description content=''>
		<meta name=author content='Xing Liu'>
		<meta name=viewport content='width=device-width, initial-scale=1.0'>

		<link rel=icon type=image/png href=/icon.png>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital@0;1&display=swap" rel="stylesheet">
    <style>
html{
  font-size: 16px;
  font-family: 'Bodoni Moda', serif;
}
html, body {
  background: #cbf;
  margin: 0;
  width: 100%;
  height: 100%;
}
body {
  display: flex;
}
main, aside {
  overflow: scroll;
  padding: 1rem;
}
h1,h2,h3,h4,h5,h6 {
  font-weight: normal;
  margin: 0;
}
* {
  box-sizing: border-box;
  transition-duration: 200ms;
  transition-property: background, fill;
}
[hidden] {
  display: none;
}

/* SIDE PANEL */
@media screen and (max-width:50rem) {
  body {
    flex-direction: column-reverse;
    height: auto;
  }
  main {
    max-height: 90vh;
    align-content: start;
  }
  aside {
    max-width: 100%;
  }
}
@media screen and (min-width:50rem) {
  main, aside {
    height: 100%;
  }
  main {
    align-content: center;
  }
  aside {
    height: auto;
    width: 24rem;
  }
}
aside label {
  display: flex;
  flex-direction: column;
  margin: 1rem 0;
}
#log {
  font-family: inherit;
}
h1 {
  text-align: center;
  font-size: 3rem;
  font-style: italic;
  filter: drop-shadow(0 2pt white);
}
h2 {
  margin-top: 2rem;
  padding-top: 1rem;
  border-top: 1pt solid white;
}

main {
  display: grid;
  flex-grow: 1;
  font-size: calc(2pt + 2vmin);
	grid-template-columns: repeat(auto-fit, 7em);
	grid-auto-rows: 8em;
  grid-gap: 1em;
  justify-content: center;
}

.card {
  display: flex;
  border-radius: 1em;
  padding: 1em;
  width: 100%;
  height: 100%;
  background: white;
}
.card:hover {
  background: #aaa;
}
.card[data-checked] {
  background: #888;
}
svg {
  --color: black;
  fill: var(--color);
  stroke: var(--color);
  stroke-width: 5;
}

/* number */
.f0_0>:first-child, .f0_0>:last-child { display: none }
.f0_1>:last-child { display: none }

.f0_1>.shape { y: 20 }
/* shades */
.f1_0 { fill-opacity: 0 }
.f1_1 { fill-opacity: 0.3 }
.f1_2 { fill-opacity: 1 }

/* colors */
.f2_0 { --color: red }
.f2_1 { --color: green }
.f2_2 { --color: blue }

/* shapes */
.f3_0 {  }
.f3_1 {  }
.f3_2 {  }

/* rotations */
.f4_0 { transform: rotate(0deg) }
.f4_1 { transform: rotate(45deg) }
.f4_2 { transform: rotate(-45deg) }

/* something */
.f5_0 {  }
.f5_1 {  }
.f5_2 {  }

    </style>
	</head>
	<body>
		<aside>
			<h1>Cliques!</h1>
			<section>
				<h2>Players</h2>
				<ol id=players>
					<li>You</li>
				</ol>
        <label>
          <span>Invite others online:</span>
         <input type=text readonly value=https://x-ing.space/cliques#pqrstuvwxyz disabled>
        </label>
			</section>
			<form id=settings>
				<h2>Settings</h2>
				<label id=time>
					<span>Time limit (seconds) (0 is infinite)</span>
					<input type=number min=0 max=300 value=10 disabled>
					<input type=range min=0 max=300 value=10 disabled>
				</label>
				<label id=features>
					<span>Difficulty (number of features per card)</span>
					<input type=number min=1 max=6 value=4>
					<input type=range min=2 max=6 value=4>
				</label>
				<label id=features>
					<span>Threshold for extra cards (% voted in favor)</span>
					<input type=number min=0 max=100 value=100 disabled>
					<input type=range min=0 max=100 value=100 disabled>
				</label>
				<input type=submit value='New game'>
			</form>
			<form id=preferences>
				<h2>Preferences</h2>
				<label id=palette>
					<span>Color palette</span>
					<input type=number min=0 max=3 value=0 disabled>
					<input type=range min=0 max=3 value=0 disabled>
				</label>
				<label id=look>
					<span>Look</span>
					<input type=number min=0 max=3 value=0 disabled>
					<input type=range min=0 max=3 value=0 disabled>
				</label>
			</form>
			<section>
				<h2>How to play</h2>
				<p>Cliques is Xing’s open-source adaptation of the mathematical card game Set by Marsha Falco.</p>
				<p>In this game, each card has four features: number, shading, color, and shape. Each characteristic has 3 possible variations.</p>
				<p>To play, select a trio of cards. You score a point if that trio of cards is a <em>clique</em>, and lose a point otherwise.</p>
				<p>A trio is considered a <em>clique</em> if for every feature, either all three cards have the same variation, or all three cards have different variations.</p>
			</section>
      <section>
        <h2>History</h2>
        <label>
          <span>Log</span>
          <textarea id=log readonly rows=20></textarea>
        </label>
      </section>
		</aside>
		<main id=game>
		</main>
    <aside hidden>
      <template id=template-card>
        <label class=card>
          <svg class='graphic' viewBox='0 0 140 160'>
              <use class='shape' href='#c3_0' transform='translate(0 -50)'/>
<!--           <rect width='100%' height='100%' opacity='0.5'/> -->
              <use class='shape' href='#c3_0' transform='translate(0 0)'/>
              <use class='shape' href='#c3_0' transform='translate(0 50)'/>
          </svg>
          <input class=checkbox type=checkbox hidden>
        </label>
      </template>
      <template id=template-player>
        <li class=player></li>
      </template>
      <svg>
        <symbol id='c3_0'> <!-- pill -->
          <rect x='5' y='62' width='130' height='34' rx='20'/>
        </symbol>
        <symbol id='c3_1'> <!-- squiggle -->
          <path d='M5 75 c 0 0 25 -20 40 -20 c 15 0 35 15 50 15  c 15 0 40 -10 40 -10 v 15 c 0 0 -25 20 -40 20 c -15 0 -35 -15 -50 -15 c -15 0 -40 10 -40 10 z'/>
        </symbol>
        <symbol id='c3_2'> <!-- diamond -->
          <path d='M10 80 l 60 -20 l 60 20 l -60 20 z'/>
        </symbol>
      </svg>
    </aside>
		<script>
    
// shortcuts for selecting elements
const $ = (query = '*', target = document) => target.querySelector(query)
const $$ = (query = '*', target = document) => Array.from(target.querySelectorAll(query))

// create array of 0's
const A = (size) => Array(size).fill(0)

// count frequency of values in array
const N = (array, value) => array.filter(v => v===value).length

// get template
const T = (id) => document.getElementById('template-' + id)
.content.cloneNode(true)
.firstElementChild

// split underscores into features
const _ = (card) => card.split('_')

// make readable
const R = (card) => _(card).map(
  (variation,feature) => [ '123', 'abc', 'RGB', '-~+', 'xyz', '/&^' ][feature][variation]
).join(' ')

// state
const s = {
  // constants / enums
  c: {
	  clique: 3, // # of cards per clique, and # of variations per feature
    COUNT: 0,
    SHADE: 1,
    COLOR: 2,
    SHAPE: 3,
    ANGLE: 4,
    MSTRY: 5,
  },
  // DOM elements
  e: {
    game: $('#game'),
    players: $('#players'),
    settings: $('#settings'),
    log: $('#log'),
  },
  // settings
  s: {
    features: 4, // # of features per card
    palette: 0,
    look: 0,
  },
  // players
  p: {
    [Math.random()]: {
      score: 0,
      name: 'You',
      local: true,
    }
  },
  // game
  g: {
    selected: [], // selected cards
    sums: [], // sum of card feature & variations
    turn: 0, // id of current turn player
    deck: [], // all unused cards
    visible: [], // all visible cards
    history: [], // history of cliques & miscliques
  }
}

$$('aside label').forEach(label=>{
	label.addEventListener('input',event=>{
		s.s[event.target.parentElement.id] = parseInt(event.target.value)
		$$('input', label).forEach(input=>{
			input.value = event.target.value
		})
	})
})

s.e.game.addEventListener('change',event => {
  const element = event.target.parentElement
  const card = element.id
  
  // adding or removing a card?
  const addition = element.dataset.checked = event.target.checked
  
  addition ? s.g.selected.push(card) : s.g.selected.splice(s.g.selected.indexOf(card))
  
  // update sum
  _(event.target.parentElement.id)
  .forEach((feature,index)=>s.g.sums[index][feature] += addition ? 1 : -1)
  	console.log(s.g)

  // if clique reached
  if(s.g.selected.length === s.c.clique) {
    const valid = (
      s.g.sums.every(
      feature =>
      ( N(feature,1) === s.c.clique ) ||
      ( N(feature,s.c.clique) === 1 )
    ))
    
    // take turns changing scores
    s.p[s.g.turn].score += valid ? 1 : -1
    
    if(valid){
      s.g.selected
      .map( card => s.g.visible.indexOf(card) )
      .forEach( index => s.g.visible[index] = s.g.deck.pop() )
    }
    
    s.g.history.unshift(
      `${ new Date().toLocaleTimeString() }: ${ s.p[s.g.turn].name } ${ valid ? '' : 'mis' }cliqued { ${ s.g.selected.map(R).join(', ') } }.`
    )
    
    softResetGame()
    renderGame()
  }
  
})

function newGame(){

	// generate cards
	s.g.deck = (
    
    // allocate space for all cards in deck
    A(s.c.clique ** s.s.features)
    
    // add in cards
    .map( (_,i) =>
      
      // allocate space for each feature
      A(s.s.features)
      
      // unwrap index into features
      // similar to breaking down a number into component digits 
      .map( (_,k) => Math.floor( i / s.c.clique**k ) % s.c.clique )
      
      // strings are easier to handle with HTML
      .join('_')
    )
    
    // shuffle
    .map((value) => ({ value, sort: Math.random() }))
    .sort((a, b) => a.sort - b.sort)
    .map(({ value }) => value)
  )

	// put some on the table
	s.g.visible = (
    
    // allocate space for all visible cards
    A(s.c.clique * s.s.features)
    
    // remove from deck
    .map( _ => s.g.deck.pop() )
  )
  
  softResetGame()
  
  s.g.history = []
  
  s.g.scores = A(s.p.length)
  s.g.turn = Object.keys(s.p)[0]
  
	//console.log(s.s)
  renderGame()
}

function renderGame(){
  s.e.game.replaceChildren(...
    s.g.visible
    .map(card => {
      const element = T('card')
      
      // create classes for CSS, f{feature id}_{variation id}
      $('.graphic',element).classList = _(card).map(
        (variation,feature) => 'f'+feature+'_'+variation
      ).join(' ')
     
      $('.checkbox',element).checked = s.g.selected.includes(card)
      
      element.id = card
      element.title = R(card)
      
      $$('.shape',element).forEach( shape =>
        shape.setAttribute( 'href', `#c${s.c.SHAPE}_${_(card)[s.c.SHAPE] || 0}` )
      )
      
      return element
    })
  )
  s.e.players.replaceChildren(...
    Object.values(s.p)
    .map((player, index) => {
      const element = T('player')
      element.textContent = `${player.name} (${player.score})`
      return element
    })
  )
  console.log(s.g.history)
  s.e.log.value = s.g.history.join('\n')
}

function softResetGame(){
    
  // keep track of selected features & variations
  s.g.sums = (
    
    // allocate space for each feature
    A(s.s.features)
    
    // allocate space for each variation
    .map( _ => A(s.c.clique) )
    
  )
  s.g.selected = []

}

// new game
s.e.settings.addEventListener('submit',event=>{
  event.preventDefault()
  newGame()
})

newGame()
		</script>
	</body>
</html>
